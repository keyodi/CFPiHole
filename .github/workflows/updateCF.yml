# This workflow will install Python dependencies and run the update with simple fixed-delay retries in the same job
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application (Cloudflare)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 3,6'

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v6

    - name: Set up Python 3.14
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
        cache: 'pip'

    - name: Install dependencies
      run: |
        # Ensure pip is up to date
        python -m pip install --upgrade pip
        # Install dependencies; pip will use the cache set up by actions/setup-python
        pip install -r requirements.txt

    - name: Run update (with retries)
      env:
        CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        CF_IDENTIFIER: ${{ secrets.CF_IDENTIFIER }}
      run: |
        # Configurable:
        max_attempts=3       # total attempts (1 initial + retries)
        delay_seconds=300    # fixed 5-minute wait between attempts
        delay_minutes=$(( delay_seconds / 60 )) # convert to minutes
        
        attempt=1
        while true; do
          echo "Attempt $attempt of $max_attempts: running update..."

          set +e
          python main.py
          exit_code=$?
          set -e

          if [ $exit_code -eq 0 ]; then
            echo "Update succeeded on attempt $attempt."
            break
          fi

          if [ $exit_code -eq 64 ] && [ "$attempt" -lt "$max_attempts" ]; then
            echo "Rate limit (64) detected. Sleeping ${delay_minutes} min before retry..."
            sleep "${delay_seconds}"  
            attempt=$(( attempt + 1 ))
          else
            echo "Update failed with exit code $exit_code (or max retries reached)."
            exit 1
          fi
        done

