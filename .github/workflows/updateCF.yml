# This workflow will install Python dependencies and run the update with simple fixed-delay retries in the same job
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application (Cloudflare)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 3,6'

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python 3.12 (with caching)
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install dependencies
      run: |
        # Ensure pip is up to date
        python -m pip install --upgrade pip
        # Install dependencies; pip will use the cache set up by actions/setup-python
        pip install -r requirements.txt

    - name: Run update (with retries)
      env:
        CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        CF_IDENTIFIER: ${{ secrets.CF_IDENTIFIER }}
      run: |
        set -eo pipefail

        # Configurable:
        max_attempts=3       # total attempts (1 initial + retries)
        delay_seconds=300    # fixed 5-minute wait between attempts
        delay_minutes=$(( delay_seconds / 60 )) # convert to minutes
        
        attempt=1
        while true; do
          echo "Attempt $attempt of $max_attempts: running update..."
          
          if python main.py; then 
            echo "Update succeeded on attempt $attempt."
            break
          fi

          if [ "$attempt" -ge "$max_attempts" ]; then
            echo "Update failed after $attempt attempts."
            exit 1
          fi

          echo "Attempt $attempt failed â€” sleeping ${delay_minutes}min before retry..."
          sleep "${delay_seconds}"

          attempt=$(( attempt + 1 ))
        done
